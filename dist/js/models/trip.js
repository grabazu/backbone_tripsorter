define(["backbone","models/city","collections/cityList","collections/dealList"],function(t,e,n,i){var s=t.Model.extend({defaults:{isBad:!1,relevance:null},initialize:function(){this.set("steps",new t.Collection),this.get("steps").add(this.get("departure"))},getCurrentStep:function(){return this.get("steps").at(this.get("steps").length-1)},matching:function(t){return null==t||this.get("relevance")<t?this.getCurrentStep().getName()===this.get("arrival").getName()?!0:!1:void this.set("isBad",!0)},getTraveled:function(){return this.get("steps").filter(function(t){return t})},setTraveled:function(t){that=this,_.each(t,function(t){that.get("steps").add(t)})},isLoop:function(t){var e=this.get("steps").find(function(e){return e.getName()===t.getName()});return null!=e?!0:!1},isBad:function(){return this.get("isBad")},addStep:function(t,e){if(this.isLoop(t))this.set("isBad",!0);else{if("fast"===e){var n=t.getFastest();this.addRelevance(n.getDuration())}else{var n=t.getCheapest();this.addRelevance(n.getCost())}t.setComing(n),this.get("steps").add(t)}},addRelevance:function(t){null==this.get("relevance")&&this.set("relevance",0),this.set("relevance",this.get("relevance")+t)},getRelevance:function(){return this.get("relevance")},getSteps:function(){return this.get("steps")},getDetailToJSON:function(){var t=[],e=0,n=0,i=0;return this.get("steps").each(function(s){if(null!=s.getComing()){n+=s.getComing().getDuration(),i+=s.getComing().getCost();var a=Math.floor(s.getComing().getDuration()/60);10>a&&(a="0"+a);var o=s.getComing().getDuration()%60;10>o&&(o="0"+o),t[e]={name:s.getName(),hours:a,minutes:o,duration:s.getComing().getDuration(),reference:s.getComing().getReference(),transport:s.getComing().getTransport(),cost:s.getComing().getCost()}}else t[e]={name:s.getName(),duration:0,hours:null,minutes:null,transport:null,reference:null,cost:0};e++}),totalhours=Math.floor(n/60),totalmin=n%60,totalhours<10&&(totalhours="0"+totalhours),totalmin<10&&(totalmin="0"+totalmin),{duration:totalhours+"h"+totalmin,cost:i,steps:t}}});return s});